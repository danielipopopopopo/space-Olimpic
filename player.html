<!DOCTYPE html>
<html lang="he" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Space Olimpic - Crew Member</title>

    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Orbitron:wght@500;700;900&display=swap"
        rel="stylesheet">

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        :root {
            --bg-deep: #050816;
            --bg-mid: #0a0f1c;
            --accent: #00d4ff;
            --accent-glow: rgba(0, 212, 255, 0.4);
            --gold: #ffd700;
            --success: #10b981;
            --danger: #ef4444;
            --glass: rgba(255, 255, 255, 0.03);
            --glass-border: rgba(255, 255, 255, 0.08);
            --text: #ffffff;
            --text-muted: rgba(255, 255, 255, 0.6);
            --spring: cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, var(--bg-deep) 0%, var(--bg-mid) 50%, #0d1225 100%);
            color: var(--text);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
            position: relative;
            text-align: center;
        }

        /* Screen Transitions */
        .screen {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 24px;
            height: 100vh;
            z-index: 10;
        }

        .screen.active {
            display: flex;
            animation: fadeIn 0.5s var(--spring);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Inputs & Buttons */
        input {
            width: 100%;
            padding: 18px 24px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            color: white;
            font-size: 1.1rem;
            text-align: center;
            font-family: inherit;
            margin-bottom: 12px;
            transition: all 0.3s;
        }

        input:focus {
            border-color: var(--accent);
            background: rgba(0, 212, 255, 0.05);
            outline: none;
            box-shadow: 0 0 15px rgba(0, 212, 255, 0.2);
        }

        button {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, var(--accent) 0%, #a855f7 100%);
            color: #030510;
            border: none;
            border-radius: 16px;
            font-weight: 800;
            font-size: 1.1rem;
            font-family: 'Orbitron', sans-serif;
            cursor: pointer;
            transition: all 0.3s var(--spring);
            box-shadow: 0 10px 30px rgba(0, 212, 255, 0.2);
        }

        button:active {
            transform: scale(0.95);
        }

        /* Typography */
        h1 {
            font-family: 'Orbitron', sans-serif;
            color: var(--accent);
            margin-bottom: 20px;
            font-size: 2rem;
        }

        h2 {
            font-size: 1.4rem;
            color: var(--gold);
            margin-bottom: 1.5rem;
            font-family: 'Orbitron';
        }

        /* Puzzle Elements */
        #puzzleCard {
            background: var(--glass);
            backdrop-filter: blur(20px);
            padding: 30px;
            border-radius: 28px;
            border: 1px solid var(--glass-border);
            width: 100%;
            max-width: 400px;
        }

        .msg {
            min-height: 1.5em;
            margin: 15px 0;
            font-weight: 500;
        }

        .msg.ok {
            color: var(--success);
        }

        .msg.bad {
            color: var(--danger);
        }

        /* Parallax & HUD */
        .stars-container {
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 0;
        }

        .stars-layer {
            position: absolute;
            inset: -50px;
        }

        .star {
            position: absolute;
            background: white;
            border-radius: 50%;
        }

        .star-small {
            width: 1px;
            height: 1px;
            opacity: 0.4;
        }

        .star-large {
            width: 2px;
            height: 2px;
            opacity: 0.8;
            box-shadow: 0 0 5px var(--accent);
        }

        .cockpit-frame {
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 5;
            box-shadow: inset 0 0 80px rgba(0, 0, 0, 0.8);
        }

        .scanlines {
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 6;
            background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0, 212, 255, 0.01) 2px, rgba(0, 212, 255, 0.01) 4px);
        }
    </style>
</head>

<body>

    <!-- Parallax background -->
    <div class="stars-container">
        <div class="stars-layer" id="starsBack" data-speed="0.02"></div>
        <div class="stars-layer" id="starsFront" data-speed="0.05"></div>
    </div>
    <div class="cockpit-frame"></div>
    <div class="scanlines"></div>

    <!-- Screen 1: Join -->
    <div id="joinScreen" class="screen active">
        <h1>JOIN MISSION</h1>
        <div id="puzzleCard">
            <input type="text" id="nameInput" placeholder="Enter Name">
            <input type="text" id="codeInput" placeholder="Mission Code">
            <button onclick="joinGame()">BLAST OFF üöÄ</button>
        </div>
    </div>

    <!-- Screen 2: Waiting -->
    <div id="waitScreen" class="screen">
        <div style="font-size: 3rem; margin-bottom: 20px;">üõ∞Ô∏è</div>
        <h1>WAITING...</h1>
        <p>Prepare the cockpit. We launch soon.</p>
    </div>

    <!-- Screen 3: Puzzles -->
    <div id="puzzleScreen" class="screen">
        <div id="puzzleCard">
            <h2 id="qTitle">PUZZLE 1</h2>
            <p id="qDesc" style="margin-bottom: 20px; font-size: 0.9rem; color: var(--text-muted);"></p>
            <input type="text" id="answerInput" placeholder="Type answer..." autocomplete="off">
            <button onclick="handleCheck()">SUBMIT üõ∏</button>
            <div id="msg" class="msg"></div>
        </div>
    </div>

    <!-- Screen 4: Finished -->
    <div id="endScreen" class="screen">
        <div style="font-size: 4rem; margin-bottom: 20px;">üèÜ</div>
        <h1>MISSION COMPLETE</h1>
        <p>Check the leaderboard on the main screen!</p>
    </div>

    <script src="firebase-config.js"></script>
    <script src="game-manager.js"></script>

    <script>
        // Puzzle Data (Unified from play1/play2)
        const allQuestions = [
            { ans: "30", hint: "Search the board" },
            { ans: "moon", hint: "Under teacher's desk" },
            { ans: "12", hint: "By the window" },
            { ans: "24", hint: "Behind the door" },
            { ans: "20", hint: "In reading corner" },
            { ans: "80", hint: "On the shelf" },
            { ans: "8", hint: "Behind the chair" },
            { ans: "41", hint: "Check the computer" },
            { ans: "72", hint: "Main desk" },
            { ans: "space", hint: "In the closet" }
        ];

        let qIndex = 0;
        let score = 0;

        // Auto-fill from URL
        const params = new URLSearchParams(window.location.search);
        if (params.has('code')) document.getElementById('codeInput').value = params.get('code');

        // Stars setup
        function createStars(container, count, className) {
            for (let i = 0; i < count; i++) {
                const s = document.createElement('div');
                s.className = `star ${className}`;
                s.style.left = Math.random() * 100 + '%';
                s.style.top = Math.random() * 100 + '%';
                container.appendChild(s);
            }
        }
        createStars(document.getElementById('starsBack'), 50, 'star-small');
        createStars(document.getElementById('starsFront'), 20, 'star-large');

        async function joinGame() {
            const name = document.getElementById('nameInput').value.trim();
            const code = document.getElementById('codeInput').value.trim();
            if (!name || !code) return alert("Missing info!");

            try {
                await gameManager.joinRoom(code, name);
                showScreen('waitScreen');

                gameManager.listenToGameState((state) => {
                    if (state.status === 'playing') showScreen('puzzleScreen');
                    if (state.status === 'finished') showScreen('endScreen');
                });
            } catch (e) { alert(e.message); }
        }

        function handleCheck() {
            const val = document.getElementById('answerInput').value.trim().toLowerCase();
            const q = allQuestions[qIndex];
            const msg = document.getElementById('msg');

            if (val === q.ans.toLowerCase()) {
                msg.className = "msg ok";
                msg.textContent = "‚úî CORRECT!";
                score += 100;
                qIndex++;

                // Sync progress
                gameManager.updateProgress(qIndex, score);

                if (qIndex < allQuestions.length) {
                    setTimeout(() => {
                        msg.textContent = "";
                        document.getElementById('qTitle').textContent = `PUZZLE ${qIndex + 1}`;
                        document.getElementById('qDesc').textContent = q.hint;
                        document.getElementById('answerInput').value = "";
                    }, 1500);
                } else {
                    gameManager.setPlayerFinished();
                    showScreen('endScreen');
                }
            } else {
                msg.className = "msg bad";
                msg.textContent = "‚ùå INCORRECT";
                setTimeout(() => { msg.textContent = ""; }, 1500);
            }
        }

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if (id === 'puzzleScreen') {
                document.getElementById('qTitle').textContent = `PUZZLE ${qIndex + 1}`;
                document.getElementById('qDesc').textContent = allQuestions[qIndex].hint;
            }
        }

        // Handle Enter key
        document.getElementById('answerInput').addEventListener('keypress', e => {
            if (e.key === 'Enter') handleCheck();
        });
    </script>
</body>

</html>